<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Water Level Monitor</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#2d5016 0%,#68a225 100%);min-height:100vh;padding:20px}
    .container{background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px;max-width:1400px;margin:0 auto}
    h1{color:#333;text-align:center;margin-bottom:20px;font-size:2.2em}
    .status{text-align:center;padding:10px;border-radius:10px;margin-bottom:20px;font-weight:600}
    .connected{background:#d4f4dd;color:#2d5016}
    .disconnected{background:#f8d7da;color:#721c24}
    .connecting{background:#fff3cd;color:#856404}
    .loading-notice{background:#d1ecf1;color:#0c5460;padding:15px;border-radius:10px;margin-bottom:20px;text-align:center}
    .error-notice{background:#f8d7da;color:#721c24;padding:15px;border-radius:10px;margin-bottom:20px;display:none}
    .config-section{background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px}
    .config-section h3{margin-bottom:15px;color:#333}
    .config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
    input,select{width:100%;padding:10px;border:2px solid #ddd;border-radius:5px;font-size:14px}
    input:focus,select:focus{outline:none;border-color:#4a7c28}
    .button-group{display:flex;gap:10px;flex-wrap:wrap}
    button{background:linear-gradient(135deg,#4a7c28 0%,#68a225 100%);color:#fff;border:none;padding:10px 20px;border-radius:5px;font-size:14px;font-weight:600;cursor:pointer;transition:transform .2s}
    button:hover:not(:disabled){transform:scale(1.05)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .preset-btn{background:#fff;color:#4a7c28;border:2px solid #4a7c28}
    .preset-btn:hover{background:#4a7c28;color:#fff}
    .export-btn{background:linear-gradient(135deg,#2d5016 0%,#5cb85c 100%)}
    .clear-btn{background:linear-gradient(135deg,#8b6f47 0%,#b8a074 100%)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .stat-card{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);border-radius:10px;padding:15px;text-align:center}
    .stat-label{font-size:.9em;color:#666;margin-bottom:5px}
    .stat-value{font-size:1.8em;font-weight:700;color:#333}
    .sensors-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .sensor-card{background:linear-gradient(135deg,#4a7c28 0%,#68a225 100%);border-radius:15px;padding:20px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .sensor-card h3{margin-bottom:15px}
    .water-level-display{font-size:2.5em;font-weight:700;margin:15px 0;text-align:center}
    .tank-visual{width:100%;height:120px;background:rgba(255,255,255,.2);border-radius:10px;position:relative;overflow:hidden;margin:15px 0}
    .water-fill{position:absolute;bottom:0;width:100%;background:linear-gradient(180deg,#4fc3f7 0%,#29b6f6 100%);transition:height 1s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .sensor-info{display:flex;justify-content:space-between;font-size:.9em;opacity:.9}
    .history-section{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .history-table{width:100%;max-height:300px;overflow-y:auto}
    .history-table table{width:100%;border-collapse:collapse}
    .history-table th{background:#4a7c28;color:#fff;padding:10px;text-align:left;position:sticky;top:0}
    .history-table td{padding:8px;border-bottom:1px solid #ddd}
    .message-log{background:#f8f9fa;border-radius:10px;padding:15px;margin-top:20px;max-height:200px;overflow-y:auto}
    .message-log h3{margin-bottom:10px;color:#333}
    .log-entry{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;padding:5px;border-bottom:1px solid #ddd;word-wrap:break-word}
    .footer-info{text-align:center;color:#666;font-size:.9em;margin-top:20px}
    .map-container{background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .map-container h3{margin-bottom:15px;color:#333}
    .map-wrapper{position:relative;width:100%;height:400px;border-radius:10px;overflow:hidden;border:2px solid #ddd;background:#eaf6ea}
    .sensor-overlay{position:absolute;background:#fff;border:3px solid #4a7c28;border-radius:10px;padding:10px;font-size:14px;font-weight:700;color:#2d5016;box-shadow:0 2px 10px rgba(0,0,0,.2);z-index:2;min-width:120px;text-align:center;transform:translate(-50%,-50%)}
    .sensor-overlay-title{font-size:12px;color:#666;margin-bottom:5px}
    .sensor-overlay-value{font-size:18px;color:#4a7c28}
    .info-notice{background:#cce5ff;color:#004085;padding:15px;border-radius:10px;margin-bottom:20px}
    .map-links{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .map-links a{color:#4a7c28;font-weight:700;text-decoration:none;border:2px solid #4a7c28;padding:8px 12px;border-radius:8px;background:#f6fff3}
    .map-links a:hover{background:#4a7c28;color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <h1>üåä Water Level Monitor</h1>
    <div id="status" class="status disconnected">Not Connected</div>

    <div id="loadingNotice" class="loading-notice">Loading MQTT library... Please wait...</div>
    <div id="errorNotice" class="error-notice"></div>

    <div class="config-section">
      <h3>MQTT Configuration</h3>
      <div class="button-group">
        <button class="preset-btn" onclick="setPreset('mosquitto')">Test Mosquitto (Secure)</button>
        <button class="preset-btn" onclick="setPreset('hivemq')">HiveMQ Public</button>
        <button class="preset-btn" onclick="setPreset('emqx')">EMQX Public</button>
      </div>
      <br/>
      <div class="config-grid">
        <input type="text" id="broker" placeholder="Broker URL" value="test.mosquitto.org">
        <input type="text" id="port" placeholder="Port" value="8081">
        <input type="text" id="topic" placeholder="Topic" value="meshtastic/#">
        <select id="maxPoints">
          <option value="50">Keep last 50 readings</option>
          <option value="100" selected>Keep last 100 readings</option>
          <option value="200">Keep last 200 readings</option>
        </select>
      </div>
      <div class="button-group">
        <button id="connectBtn" onclick="connectMQTT()" disabled>Connect</button>
        <button id="disconnectBtn" onclick="disconnectMQTT()" style="display:none;">Disconnect</button>
        <button class="export-btn" onclick="exportData()">Export CSV</button>
        <button class="clear-btn" onclick="clearData()">Clear Data</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Sensor 1 Current</div><div class="stat-value" id="stat1">-- ft</div></div>
      <div class="stat-card"><div class="stat-label">Sensor 1 Min/Max</div><div class="stat-value" id="minmax1">-- / --</div></div>
      <div class="stat-card"><div class="stat-label">Sensor 2 Current</div><div class="stat-value" id="stat2">-- ft</div></div>
      <div class="stat-card"><div class="stat-label">Sensor 2 Min/Max</div><div class="stat-value" id="minmax2">-- / --</div></div>
    </div>

    <div class="sensors-grid">
      <div class="sensor-card">
        <h3>Water Sensor 1</h3>
        <div class="tank-visual"><div class="water-fill" id="tank1" style="height:0%"><span id="percent1">0%</span></div></div>
        <div class="water-level-display" id="level1">-- ft</div>
        <div class="sensor-info"><span>Node: <span id="node1">--</span></span><span>CPU: <span id="cpu1">--¬∞C</span></span></div>
      </div>
      <div class="sensor-card">
        <h3>Water Sensor 2</h3>
        <div class="tank-visual"><div class="water-fill" id="tank2" style="height:0%"><span id="percent2">0%</span></div></div>
        <div class="water-level-display" id="level2">-- ft</div>
        <div class="sensor-info"><span>Node: <span id="node2">--</span></span><span>CPU: <span id="cpu2">--¬∞C</span></span></div>
      </div>
    </div>

    <div class="history-section">
      <h3>Recent Readings</h3>
      <div class="history-table">
        <table>
          <thead><tr><th>Time</th><th>Sensor</th><th>Level (ft)</th><th>Node ID</th></tr></thead>
          <tbody id="historyTableBody"><tr><td colspan="4" style="text-align:center;">No data yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- MAP: iframe removed; SVG fallback + links to open Google Maps -->
    <div class="map-container">
  <h3>üìç Sensor Locations - Morro Bay, CA</h3>

  <!-- The real Google Map -->
  <div id="gmap" style="height:400px;width:100%;border-radius:10px;border:2px solid #ddd;"></div>

  <!-- Simple text readout + quick links under the map -->
  <div style="margin-top:15px;padding:15px;background:#f0f9f0;border-radius:8px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;text-align:center;">
      <div>
        <strong style="color:#4a7c28;">üìç Sensor 1</strong><br/>
        <span style="color:#666;font-size:12px;">35.2214¬∞N, 120.5138¬∞W</span><br/>
        <span style="color:#2d5016;font-size:18px;font-weight:700;" id="text-level-1">-- ft</span>
      </div>
      <div>
        <strong style="color:#4a7c28;">üìç Sensor 2</strong><br/>
        <span style="color:#666;font-size:12px;">35.1916¬∞N, 120.5119¬∞W</span><br/>
        <span style="color:#2d5016;font-size:18px;font-weight:700;" id="text-level-2">-- ft</span>
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:12px">
      <a id="gmaps1" target="_blank" rel="noopener">Open Sensor 1 in Google Maps ‚Üí</a>
      <a id="gmaps2" target="_blank" rel="noopener">Open Sensor 2 in Google Maps ‚Üí</a>
      <a id="gmapsArea" target="_blank" rel="noopener">Open Area in Google Maps ‚Üí</a>
    </div>
  </div>
</div>


      <!-- Text-based info + links to open full Google Maps -->
      <div style="margin-top:15px;padding:15px;background:#f0f9f0;border-radius:8px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;text-align:center;">
          <div>
            <strong style="color:#4a7c28;">üìç Sensor 1</strong><br/>
            <span style="color:#666;font-size:12px;">35.2214¬∞N, 120.5138¬∞W</span><br/>
            <span style="color:#2d5016;font-size:18px;font-weight:700;" id="text-level-1">-- ft</span>
          </div>
          <div>
            <strong style="color:#4a7c28;">üìç Sensor 2</strong><br/>
            <span style="color:#666;font-size:12px;">35.1916¬∞N, 120.5119¬∞W</span><br/>
            <span style="color:#2d5016;font-size:18px;font-weight:700;" id="text-level-2">-- ft</span>
          </div>
        </div>
        <div class="map-links">
          <a id="gmaps1" target="_blank" rel="noopener">Open Sensor 1 in Google Maps ‚Üí</a>
          <a id="gmaps2" target="_blank" rel="noopener">Open Sensor 2 in Google Maps ‚Üí</a>
          <a id="gmapsArea" target="_blank" rel="noopener">Open Area in Google Maps ‚Üí</a>
        </div>
      </div>
    </div>

    <div class="message-log">
      <h3>Message Log</h3>
      <div id="messageLog"><div class="log-entry">Waiting for MQTT library to load...</div></div>
    </div>

    <div class="footer-info">
      Last Update: <span id="lastUpdate">Never</span> |
      Total Readings: <span id="totalReadings">0</span>
    </div>
  </div>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>

  <script>
    // ---------- Existing app state ----------
    let client=null, mqttAvailable=false;
    const MAX_TANK_HEIGHT=10;
    let maxDataPoints=100;
    const isHTTPS=location.protocol==='https:';

    const sensor1Data={from:null,history:[],nodeId:null,min:null,max:null};
    const sensor2Data={from:null,history:[],nodeId:null,min:null,max:null};

    // ---------- Logging & errors ----------
    function addLog(msg){
      const box=document.getElementById('messageLog');
      const div=document.createElement('div');
      div.className='log-entry';
      div.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      box.insertBefore(div,box.firstChild);
      while(box.children.length>20) box.removeChild(box.lastChild);
    }
    function showError(message){
      const el=document.getElementById('errorNotice');
      el.textContent='‚ö†Ô∏è '+message;
      el.style.display='block';
      setTimeout(()=>el.style.display='none',10000);
      console.error(message);
    }

    // ---------- MQTT library load ----------
    function checkMQTT(){
      if(typeof mqtt!=='undefined'){
        mqttAvailable=true;
        document.getElementById('connectBtn').disabled=false;
        document.getElementById('loadingNotice').style.display='none';
        addLog('MQTT library loaded');
        if(isHTTPS) addLog('HTTPS detected ‚Üí WSS will be used.');
      }else{
        // fallback CDN
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
        s.onload=checkMQTT;
        s.onerror=()=>{ showError('Unable to load MQTT library.'); document.getElementById('loadingNotice').style.display='none'; };
        document.head.appendChild(s);
      }
    }
    window.addEventListener('load', ()=>{
      setTimeout(checkMQTT, 300);
      // Auto-connect if desired
      setTimeout(()=>{ if(mqttAvailable && !client) connectMQTT(); }, 2000);
      // Build mini map + links
      setupMiniMap();
    });

    // ---------- Presets ----------
    function setPreset(p){
      const isHttps=location.protocol==='https:';
      const broker=document.getElementById('broker');
      const port=document.getElementById('port');
      const topic=document.getElementById('topic');
      if(p==='mosquitto'){ broker.value='test.mosquitto.org'; port.value=isHttps?'8081':'8080'; topic.value=topic.value||'dl/water/#'; }
      if(p==='emqx'){ broker.value='broker.emqx.io'; port.value=isHttps?'8084':'8083'; topic.value=topic.value||'dl/water/#'; }
      if(p==='hivemq'){ broker.value='broker.hivemq.com'; port.value='8000'; topic.value=topic.value||'dl/water/#'; if(isHttps) addLog('Note: HiveMQ Public is ws only; use Mosquitto 8081 on HTTPS.'); }
      addLog(`Preset: ${p} selected`);
    }

    // ---------- Connect / Disconnect ----------
    function connectMQTT(){
      if(!mqttAvailable){ showError('MQTT library not ready.'); return; }
      const broker=document.getElementById('broker').value.trim();
      let port=document.getElementById('port').value.trim();
      const topic=document.getElementById('topic').value.trim();
      maxDataPoints=parseInt(document.getElementById('maxPoints').value||'100',10);
      if(!broker||!port||!topic){ showError('Enter broker, port, and topic.'); return; }

      document.getElementById('status').className='status connecting';
      document.getElementById('status').textContent='Connecting...';

      if(client) try{ client.end(true); }catch{}
      let scheme=isHTTPS?'wss':'ws';
      if(isHTTPS && port==='8080'){ port='8081'; document.getElementById('port').value='8081'; addLog('Auto-corrected 8080‚Üí8081 for secure WSS.'); }
      const url=`${scheme}://${broker}:${port}/mqtt`;
      addLog(`Connecting to ${url}`);

      client=mqtt.connect(url,{ clientId:'water-'+Math.random().toString(16).slice(2), clean:true, connectTimeout:10000, reconnectPeriod:5000 });

      client.on('connect',()=>{
        document.getElementById('status').className='status connected';
        document.getElementById('status').textContent=`Connected to ${broker}:${port}`;
        document.getElementById('connectBtn').style.display='none';
        document.getElementById('disconnectBtn').style.display='inline-block';
        client.subscribe(topic,(err)=>{
          if(err) addLog(`Subscribe error: ${err.message||err}`); else addLog(`Subscribed: ${topic}`);
        });
      });

      client.on('error',(err)=>{
        document.getElementById('status').className='status disconnected';
        document.getElementById('status').textContent='Connection Error';
        document.getElementById('connectBtn').style.display='inline-block';
        document.getElementById('disconnectBtn').style.display='none';
        addLog(`Error: ${err?.message||err}`);
      });

      client.on('offline',()=>{
        document.getElementById('status').className='status disconnected';
        document.getElementById('status').textContent='Offline';
      });

      client.on('message',(t,buf)=>{
        // Expect Meshtastic text JSON; fall back to raw string
        const raw=new TextDecoder().decode(buf);
        let text='';
        try{
          const j=JSON.parse(raw);
          text=j?.payload?.text || j?.decoded?.text || j?.text || '';
        }catch{ text=raw; }
        if(!text) return;

        addLog(`Topic: ${t}`); addLog(`Message: ${text}`);

        const levelMatch = text.match(/([0-9]+(?:\.[0-9]+)?)\s*(?:feet|ft)\b/i) || text.match(/Level:\s*([0-9.]+)/i);
        const cpuMatch   = text.match(/CPU:\s*([0-9.]+)¬∞?C/i);
        if(!levelMatch) return;
        const level=Number(levelMatch[1]);
        const cpu = cpuMatch ? Number(cpuMatch[1]) : null;
        const nodeId=t.split('/').pop();

        // Simple mapping: first "from" becomes S1, next becomes S2
        let from=null; try{ const j=JSON.parse(raw); from=j.from||j.sender||null; }catch{}
        if(!sensor1Data.from){ sensor1Data.from=from; sensor1Data.nodeId=nodeId; updateSensor(1,level,cpu,nodeId); return; }
        if(from===sensor1Data.from){ updateSensor(1,level,cpu,nodeId); }
        else { sensor2Data.from=from; sensor2Data.nodeId=nodeId; updateSensor(2,level,cpu,nodeId); }
      });
    }
    function disconnectMQTT(){
      if(client) client.end(true);
      document.getElementById('status').className='status disconnected';
      document.getElementById('status').textContent='Disconnected';
      document.getElementById('connectBtn').style.display='inline-block';
      document.getElementById('disconnectBtn').style.display='none';
      addLog('Disconnected');
    }

    // ---------- UI updates ----------
    function updateSensor(num, level, cpu, nodeId){
      const ts=new Date();
      const d=(num===1)?sensor1Data:sensor2Data;

      document.getElementById(`level${num}`).textContent=`${level.toFixed(1)} ft`;
      document.getElementById(`stat${num}`).textContent =`${level.toFixed(1)} ft`;
      if(nodeId) document.getElementById(`node${num}`).textContent=(nodeId||'').substring(0,10);
      if(cpu!=null) document.getElementById(`cpu${num}`).textContent=`${cpu}¬∞C`;

      d.min=(d.min==null||level<d.min)?level:d.min;
      d.max=(d.max==null||level>d.max)?level:d.max;
      document.getElementById(`minmax${num}`).textContent=
        `${d.min?.toFixed(1)??'--'} / ${d.max?.toFixed(1)??'--'}`;

      const pct=Math.min(100,Math.max(0,(level/MAX_TANK_HEIGHT)*100));
      document.getElementById(`tank${num}`).style.height=`${pct}%`;
      document.getElementById(`percent${num}`).textContent=`${Math.round(pct)}%`;

      d.history.push({time:ts,level,cpu});
      if(d.history.length>maxDataPoints) d.history.shift();
      updateHistoryTable();

      // Map overlays + text
      const mapLevel=document.getElementById(`map-level-${num}`);
      if(mapLevel) mapLevel.textContent=`${level.toFixed(1)} ft`;
      const textLevel=document.getElementById(`text-level-${num}`);
      if(textLevel) textLevel.textContent=`${level.toFixed(1)} ft`;

      document.getElementById('lastUpdate').textContent=ts.toLocaleTimeString();
      document.getElementById('totalReadings').textContent=sensor1Data.history.length+sensor2Data.history.length;
    }

    function updateHistoryTable(){
      const tbody=document.getElementById('historyTableBody');
      const rows=[];
      sensor1Data.history.forEach(x=>rows.push({t:x.time,s:'Sensor 1',v:x.level,n:sensor1Data.nodeId}));
      sensor2Data.history.forEach(x=>rows.push({t:x.time,s:'Sensor 2',v:x.level,n:sensor2Data.nodeId}));
      rows.sort((a,b)=>b.t-a.t);
      tbody.innerHTML = rows.slice(0,20).map(r=>(
        `<tr><td>${r.t.toLocaleTimeString()}</td><td>${r.s}</td><td>${r.v.toFixed(1)}</td><td>${r.n?r.n.substring(0,10):'--'}</td></tr>`
      )).join('') || '<tr><td colspan="4" style="text-align:center;">No data yet</td></tr>';
    }

    // ---------- Mini-map (SVG) + links ----------
    const BBOX={ // rough area bounds (W,E,S,N)
      w:-120.5350, e:-120.4900, s:35.1800, n:35.2400
    };
    const SENSORS={
      1:{name:'Sensor 1', lat:35.221400, lng:-120.513800},
      2:{name:'Sensor 2', lat:35.191600, lng:-120.511900}
    };

    function lonLatToXY(lng,lat, W=800, H=400){
      const x=(lng-BBOX.w)/(BBOX.e-BBOX.w)*W;
      const y=(1-(lat-BBOX.s)/(BBOX.n-BBOX.s))*H;
      return {x,y};
    }
    function setupMiniMap(){
      // Place pins in SVG
      const svg=document.getElementById('miniMapSvg');
      const p1=lonLatToXY(SENSORS[1].lng,SENSORS[1].lat);
      const p2=lonLatToXY(SENSORS[2].lng,SENSORS[2].lat);
      const g1=svg.querySelector('#pin-1'), g2=svg.querySelector('#pin-2');
      g1.setAttribute('transform',`translate(${p1.x},${p1.y})`);
      g2.setAttribute('transform',`translate(${p2.x},${p2.y})`);

      // Position overlays in the same relative spots
      const wrap=document.getElementById('mapWrapper');
      function placeOverlay(overlayEl, p){
        const left=(p.x/800)*100, top=(p.y/400)*100;
        overlayEl.style.left=left+'%';
        overlayEl.style.top =top +'%';
      }
      placeOverlay(document.getElementById('overlay1'), p1);
      placeOverlay(document.getElementById('overlay2'), p2);

      // Build Google Maps links
      const gm1=`https://www.google.com/maps/search/?api=1&query=${SENSORS[1].lat},${SENSORS[1].lng}`;
      const gm2=`https://www.google.com/maps/search/?api=1&query=${SENSORS[2].lat},${SENSORS[2].lng}`;
      const centerLat=((SENSORS[1].lat+SENSORS[2].lat)/2).toFixed(6);
      const centerLng=((SENSORS[1].lng+SENSORS[2].lng)/2).toFixed(6);
      const area=`https://www.google.com/maps/search/?api=1&query=${centerLat},${centerLng}`;

      document.getElementById('gmaps1').href=gm1;
      document.getElementById('gmaps2').href=gm2;
      document.getElementById('gmapsArea').href=area;
    }
  </script>
</body>
</html>
